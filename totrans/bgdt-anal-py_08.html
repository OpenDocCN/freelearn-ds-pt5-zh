<html><head></head><body>
		<div class="Content" id="_idContainer159">
			<h1 id="_idParaDest-190"><em class="italics"><a id="_idTextAnchor214"/>Chapter 8</em></h1>
		</div>
		<div class="Content" id="_idContainer160">
			<h1 id="_idParaDest-191"><a id="_idTextAnchor215"/>Creating a Full Analysis Report</h1>
		</div>
		<div class="Content" id="_idContainer161">
			<h2>Learning Objectives</h2>
			<p>By the end of this chapter, you will be able to:</p>
			<ul>
				<li class="bullets">Read data from different sources in Spark</li>
				<li class="bullets">Perform SQL operations on a Spark DataFrame</li>
				<li class="bullets">Generate statistical measurements in a consistent way</li>
				<li class="bullets">Generate graphs and plots using Plotly</li>
				<li class="bullets">Compile an analysis report incorporating all the previous steps and data</li>
			</ul>
			<p>In this chapter, we will read the data using Spark, aggregating it, and extract the statistical measurements. We will also use the Pandas to generate graphs from aggregated data and form an analysis report.</p>
		</div>
		<div class="Content" id="_idContainer179">
			<h2 id="_idParaDest-192"><a id="_idTextAnchor216"/>Introduction</h2>
			<p>If you have been part of the data industry for a while, you will understand the challenge of working with different data sources, analyzing them, and presenting them in consumable business reports. When using Spark on Python, you may have to read data from various sources, such as flat files, REST APIs in JSON format, and so on. </p>
			<p>In the real world, getting data in the right format is always a challenge and several SQL operations are required to gather data. Thus, it is mandatory for any data scientist to know how to handle different file formats and different sources, and to carry out basic SQL operations and present them in a consumable format. </p>
			<p>This chapter provides common methods for reading different types of data, carrying out SQL operations on it, doing descriptive statistical analysis, and generating a full analysis report. We will start with understanding how to read different kinds of data into PySpark and will then generate various analyses and plots on it.</p>
			<h2 id="_idParaDest-193"><a id="_idTextAnchor217"/>Reading Data in Spark from Different Data Sources</h2>
			<p>One of the advantages of Spark is the ability to read data from various data sources. However, this is not consistent and keeps changing with each Spark version. This section of the chapter will explain how to read files in CSV and JSON.</p>
			<h3 id="_idParaDest-194"><a id="_idTextAnchor218"/>Exercise 47: Reading Data from a CSV File Using the PySpark Object</h3>
			<p>To read CSV data, you have to write the <strong class="inline">spark.read.csv("the file name with .csv")</strong> function. Here, we are reading the bank data that was used in the earlier chapters.</p>
			<h4>Note</h4>
			<p class="callout">The <strong class="inline">sep</strong> function is used here.</p>
			<p>We have to ensure that the right <strong class="inline">sep</strong> function is used based on how the data is separated in the source data.</p>
			<p>Now let's perform the following steps to read the data from the <strong class="inline">bank.csv</strong> file:</p>
			<ol>
				<li>First, let's import the required packages into the Jupyter notebook:<p class="snippet">import os</p><p class="snippet">import pandas as pd</p><p class="snippet">import numpy as np</p><p class="snippet">import collections</p><p class="snippet">from sklearn.base import TransformerMixin</p><p class="snippet">import random</p><p class="snippet">import pandas_profiling</p></li>
				<li>Next, import all the required libraries, as illustrated:<p class="snippet">import seaborn as sns</p><p class="snippet">import time</p><p class="snippet">import re</p><p class="snippet">import os</p><p class="snippet">import matplotlib.pyplot as plt</p></li>
			</ol>
			<p>Now, use the <strong class="inline">tick</strong> themes, which will make our dataset more visible and provide higher contrast:</p>
			<p class="snippet">sns.set(style="ticks")</p>
			<ol>
				<li value="1">Now, change the working directory using the following command:<p class="snippet">os.chdir("/Users/svk/Desktop/packt_exercises")</p></li>
				<li>Let's import the libraries required for Spark to build the Spark session:<p class="snippet">from pyspark.sql import SparkSession</p><p class="snippet">spark = SparkSession.builder.appName('ml-bank').getOrCreate()</p></li>
				<li>Now, let's read the CSV data after creating the <strong class="inline">df_csv</strong> Spark object using the following command:<p class="snippet">df_csv = spark.read.csv('bank.csv', sep=';', header = True, inferSchema = True)</p></li>
				<li>Print the schema using the following command:<p class="snippet">df_csv.printSchema()</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer162"><img alt="Figure 8.1: Bank schema" src="image/C12913_08_01.jpg"/></div></li>
			</ol>
			<h6>Figure 8.1: Bank schema</h6>
			<h3 id="_idParaDest-195"><a id="_idTextAnchor219"/>Reading JSON Data Using the PySpark Object</h3>
			<p>To read JSON data, you have to write the <strong class="inline">read.json("the file name with .json")</strong> function after setting the SQL context:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer163">
					<img alt="Figure 8.2: Reading JSON file in PySpark" src="image/C12913_08_02.jpg"/>
				</div>
			</div>
			<h6>Figure 8.2: Reading JSON file in PySpark</h6>
			<h2 id="_idParaDest-196">SQ<a id="_idTextAnchor220"/>L Operations on a Spark DataFrame</h2>
			<p>A DataFrame in Spark is a distributed collection of rows and columns. It is the same as a table in a relational database or an Excel sheet. A Spark RDD/DataFrame is efficient at processing large amounts of data and has the ability to handle petabytes of data, whether structured or unstructured. </p>
			<p>Spark optimizes queries on data by organizing the DataFrame into columns, which helps Spark understand the schema. Some of the most frequently used SQL operations include subsetting the data, merging the data, filtering, selecting specific columns, dropping columns, dropping all null values, and adding new columns, among others.</p>
			<h3 id="_idParaDest-197">Ex<a id="_idTextAnchor221"/>ercise 48: Reading Data in PySpark and Carrying Out SQL Operations</h3>
			<p>For summary statistics of data, we can use the <strong class="inline">spark_df.describe().show()</strong> function, which will provide information on <strong class="inline">count</strong>, <strong class="inline">mean</strong>, <strong class="inline">standard deviation</strong>, <strong class="inline">max</strong>, and <strong class="inline">min</strong> for all the columns in the DataFrame. </p>
			<p>For example, in the dataset that we have considered—the bank marketing dataset (<a href="https://raw.githubusercontent.com/TrainingByPackt/Big-Data-Analysis-with-Python/master/Lesson08/bank.csv">https://raw.githubusercontent.com/TrainingByPackt/Big-Data-Analysis-with-Python/master/Lesson08/bank.csv</a>)—the summary statistics data can be obtained as follows:</p>
			<ol>
				<li value="1">After creating a new Jupyter notebook, import all the required packages, as illustrated here:<p class="snippet">import os</p><p class="snippet">import pandas as pd</p><p class="snippet">import numpy as np</p></li>
				<li>Now, change the working directory using the following command:<p class="snippet">os.chdir("/Users/svk/Desktop/packt_exercises")</p></li>
				<li>Import all the libraries required for Spark to build the Spark session:<p class="snippet">from pyspark.sql import SparkSession</p><p class="snippet">spark = SparkSession.builder.appName('ml-bank').getOrCreate()</p></li>
				<li>Create and read the data from the CSV file using the Spark object, as illustrated:<p class="snippet">spark_df = spark.read.csv('bank.csv', sep=';', header = True, inferSchema = True)</p></li>
				<li>Now let's print the first five rows from the Spark object using the following command:<p class="snippet">spark_df.head(5)</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer164"><img alt="Figure 8.3: Bank data of first five rows (Unstructured)" src="image/C12913_08_03.jpg"/></div><h6>Figure 8.3: Bank data of first five rows (Unstructured)</h6></li>
				<li>The previous output is unstructured. Let's first identify the data types to proceed to get the structured data. Use the following command to print the datatype of each column:<p class="snippet">spark_df.printSchema()</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer165"><img alt="Figure 8.4: Bank datatypes (Structured)" src="image/C12913_08_04.jpg"/></div><h6>Figure 8.4: Bank datatypes (Structured)</h6></li>
				<li>Now let's calculate the total number of rows and columns with names to get a clear idea of the data we have:<p class="snippet">spark_df.count()</p><p>The output is as follows:</p><p class="snippet">4521</p><p class="snippet">len(spark_df.columns), spark_df.columns</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer166"><img alt="Figure 8.5: Total number of rows and columns names" src="image/Image38437.jpg"/></div><h6>Figure 8.5: Total number of rows and columns names</h6></li>
				<li>Print the summary statistics for the DataFrame using the following command:<p class="snippet">spark_df.describe().show()</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer167"><img alt="Figure 8.6: Summary statistics of numerical columns" src="image/C12913_08_06.jpg"/></div><h6>Figure 8.6: Summary statistics of numerical columns</h6><p>To select multiple columns from a DataFrame, we can use the <strong class="inline">spark_df.select('col1', 'col2', 'col3')</strong> function. For example, let's select the first five rows from the <strong class="inline">balance</strong> and <strong class="inline">y</strong> columns using the following command:</p><p class="snippet">spark_df.select('balance','y').show(5)</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer168"><img alt="Figure 8.7: Data of the balance and y columns" src="image/C12913_08_07.jpg"/></div><h6>Figure 8.7: Data of the balance and y columns</h6></li>
				<li>To identify the relation between two variables in terms of their frequency of levels, <strong class="inline">crosstab</strong> can be used. To derive crosstab between two columns, we can use the <strong class="inline">spark_df.crosstab('col1', col2)</strong> function. Crosstab is carried out between two categorical variables and not between numerical variables:<p class="snippet">spark_df.crosstab('y', 'marital').show()</p><div class="IMG---Figure" id="_idContainer169"><img alt="Figure 8.8: Pair wise frequency of categorical columns" src="image/C12913_08_08.jpg"/></div><h6>Figure 8.8: Pair wise frequency of categorical columns</h6></li>
				<li>Now, let's add a new column to the dataset:<p class="snippet"># sample sets</p><p class="snippet">sample1 = spark_df.sample(False, 0.2, 42)</p><p class="snippet">sample2 = spark_df.sample(False, 0.2, 43)</p><p class="snippet"># train set</p><p class="snippet">train = spark_df.sample(False, 0.8, 44)</p><p class="snippet">train.withColumn('balance_new', train.balance /2.0).select('balance','balance_new').show(5)</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer170"><img alt="Figure 8.9: Data of newly added column" src="image/C12913_08_09.jpg"/></div><h6>Figure 8.9: Data of newly added column</h6></li>
				<li>Drop the newly created column using the following command:<p class="snippet">train.drop('balance_new)</p></li>
			</ol>
			<h3 id="_idParaDest-198"><a id="_idTextAnchor222"/>Exercise 49: Creating and Merging Two DataFrames</h3>
			<p>In this exercise, we will extract and use the bank marketing data (<a href="https://archive.ics.uci.edu/ml/datasets/bank+marketing">https://archive.ics.uci.edu/ml/datasets/bank+marketing</a>) from the UCI Machine Learning Repository. The objective is to carry out merge operations on a Spark DataFrame using PySpark.</p>
			<p>The data is related to the direct marketing campaigns of a Portuguese banking institution. The marketing campaigns were based on phone calls. Often, more than one contact for the same client was required, in order to access whether the product (<strong class="bold">bank term deposit</strong>) would be (<strong class="bold">yes</strong>) or would not be (<strong class="bold">no</strong>) subscribed.</p>
			<p>Now, let's create two DataFrames from the current bank marketing data and merge them on the basis of a primary key:</p>
			<ol>
				<li value="1">First, let's import the required header files in the Jupyter notebook:<p class="snippet">import os</p><p class="snippet">import pandas as pd</p><p class="snippet">import numpy as np</p><p class="snippet">import pyspark</p></li>
				<li>Now, change the working directory using the following command:<p class="snippet">os.chdir("/Users/svk/Desktop/packt_exercises")</p></li>
				<li>Import all the libraries required for Spark to build the Spark session:<p class="snippet">from pyspark.sql import SparkSession</p><p class="snippet">spark = SparkSession.builder.appName('ml-bank').getOrCreate()</p></li>
				<li>Read the data from the CSV files into a Spark object using the following command:<p class="snippet">spark_df = spark.read.csv('bank.csv', sep=';', header = True, inferSchema = True)</p></li>
				<li>Print the first five rows from the Spark object:<p class="snippet">spark_df.head(5)</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer171"><img alt="" src="image/Image38484.jpg"/></div><h6>Figure 8.10: Bank data of first five rows (Unstructured)</h6></li>
				<li>Now, to merge the two DataFrames using the primary key (ID), first, we will have to split it into two DataFrames.</li>
				<li>First, add a new DataFrame with an <strong class="inline">ID</strong> column:<p class="snippet">from pyspark.sql.functions import monotonically_increasing_id</p><p class="snippet">train_with_id = spark_df.withColumn("ID", monotonically_increasing_id())</p></li>
				<li>Then, create another column, <strong class="inline">ID2</strong>:<p class="snippet">train_with_id = train_with_id.withColumn('ID2', train_with_id.ID)</p></li>
				<li>Split the DataFrame using the following command:<p class="snippet">train_with_id1 = train_with_id.drop('balance', "ID2")</p><p class="snippet">train_with_id2 = train_with_id.select('balance', "ID2")</p></li>
				<li>Now, change the ID column names of <strong class="inline">train_with_id2</strong>:<p class="snippet">train_with_id2 = train_with_id2.withColumnRenamed("ID2", "ID")</p></li>
				<li>Merge <strong class="inline">train_with_id1</strong> and <strong class="inline">train_with_id2</strong> using the following command:<p class="snippet">train_merged = train_with_id1.join(train_with_id2, on=['ID'], how='left_outer')</p></li>
			</ol>
			<h3 id="_idParaDest-199">Exercise 50<a id="_idTextAnchor223"/>: Subsetting the DataFrame</h3>
			<p>In this exercise, we will extract and use the bank marketing data (<a href="https://archive.ics.uci.edu/ml/datasets/bank+marketing">https://archive.ics.uci.edu/ml/datasets/bank+marketing</a>) from the UCI Machine Learning Repository. The objective is to carry out filter/subsetting operations on the Spark DataFrame using PySpark.</p>
			<p>Let's subset the DataFrame where the balance is greater than <strong class="inline">0</strong> in the bank marketing data:</p>
			<ol>
				<li value="1">First, let's import the required header files in the Jupyter notebook:<p class="snippet">import os</p><p class="snippet">import pandas as pd</p><p class="snippet">import numpy as np</p><p class="snippet">import pyspark</p></li>
				<li>Now, change the working directory using the following command:<p class="snippet">os.chdir("/Users/svk/Desktop/packt_exercises")</p></li>
				<li>Import all the libraries required for Spark to build the Spark session:<p class="snippet">from pyspark.sql import SparkSession</p><p class="snippet">spark = SparkSession.builder.appName('ml-bank').getOrCreate()</p></li>
				<li>Now, read the CSV data as a Spark object using the following command:<p class="snippet">spark_df = spark.read.csv('bank.csv', sep=';', header = True, inferSchema = True)</p></li>
				<li>Let's run SQL queries to subset and filter the DataFrame:<p class="snippet">train_subsetted = spark_df.filter(spark_df.balance &gt; 0.0)</p><p class="snippet">pd.DataFrame(train_subsetted.head(5))</p><p>The output is as follows:</p><div class="IMG---Figure" id="_idContainer172"><img alt="" src="image/Image38496.jpg"/></div></li>
			</ol>
			<h6>Figure 8.11: Filtered DataFrame</h6>
			<h2 id="_idParaDest-200">Generating <a id="_idTextAnchor224"/>Statistical Measurements</h2>
			<p>Python is a general-purpose language with statistical modules. A lot of statistical analysis, such as carrying out descriptive analysis, which includes identifying the distribution of data for numeric variables, generating a correlation matrix, the frequency of levels in categorical variables with identifying mode and so on, can be carried out in Python. The following is an example of correlation:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer173">
					<img alt="Figure 8.12: Segment numeric data and correlation matrix output" src="image/C12913_08_12.jpg"/>
				</div>
			</div>
			<h6>Figure 8.12: Segment numeric data and correlation matrix output</h6>
			<p>Identifying the distribution of data and normalizing it is important for parametric models such as <strong class="bold">linear regression</strong> and <strong class="bold">support vector machines</strong>. These algorithms assume the data to be normally distributed. If data is not normally distributed, it can lead to bias in the data. In the following example, we will identify the distribution of data through a normality test and then apply a transformation using the <strong class="inline">yeo-johnson</strong> method to normalize the data:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer174">
					<img alt="Figure 8.13: Identifying the distribution of the data—Normality test" src="image/C12913_08_13.jpg"/>
				</div>
			</div>
			<h6>Figure 8.13: Identifying the distribution of the data—Normality test</h6>
			<p>The identified variables are then normalized using <strong class="inline">yeo-johnson</strong> or the <strong class="inline">box-cox</strong> method.</p>
			<p>Generating the importance of features is important in a data science project where predictive techniques are used. This broadly falls under statistical analysis as various statistical techniques are used to identify the important variables. One of the methods that's used here is <strong class="inline">Boruta</strong>, which is a wrap-around <strong class="inline">RandomForest</strong> algorithm for variable importance analysis. For this, we will be using the <strong class="inline">BorutaPy</strong> package:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer175">
					<img alt="Figure 8.14: Feature importance" src="image/C12913_08_14.jpg"/>
				</div>
			</div>
			<h6>Figure 8.14: Feature importance</h6>
			<h3 id="_idParaDest-201"><a id="_idTextAnchor225"/>Activity 15: Generating Visualization Using Plotly</h3>
			<p>In this activity, we will extract and use the bank marketing data from the UCI Machine Learning Repository. The objective is to generate visualizations using Plotly in Python.</p>
			<h4>Note</h4>
			<p class="callout">Plotly's Python graphing library makes interactive, publication-quality graphs.</p>
			<p>Perform the following steps to generate the visualization using Plotly:</p>
			<ol>
				<li value="1">Import the required libraries and packages into the Jupyter notebook.</li>
				<li>Import the libraries required for Plotly to visualize the data visualization:<p class="snippet">import plotly.graph_objs as go</p><p class="snippet">from plotly.plotly import iplot</p><p class="snippet">import plotly as py</p></li>
				<li>Read the data from the <strong class="inline">bank.csv</strong> file into the Spark DataFrame.</li>
				<li>Check the Plotly version that you are running on your system. Make sure you are running the updated version. Use the <strong class="inline">pip install plotly --upgrade</strong> command and then run the following code:<p class="snippet">from plotly import __version__</p><p class="snippet">from plotly.offline import download_plotlyjs, init_notebook_mode, plot, iplot</p><p class="snippet">print(__version__) # requires version &gt;= 1.9.0</p><p>The output is as follows:</p><p class="snippet">3.7.1</p></li>
				<li>Now import the required libraries to plot the graphs using Plotly:<p class="snippet">import plotly.plotly as py</p><p class="snippet">import plotly.graph_objs as go</p><p class="snippet">from plotly.plotly import iplot</p><p class="snippet">init_notebook_mode(connected=True)</p></li>
				<li>Set the Plotly credentials in the following command, as illustrated here:<p class="snippet">plotly.tools.set_credentials_file(username='Your_Username', api_key='Your_API_Key')</p><h4>Note</h4><p class="callout">To generate an API key for Plotly, sign up for an account and navigate to <a href="https://plot.ly/settings#/">https://plot.ly/settings#/</a>. Click on the <strong class="bold">API Keys</strong> option and then click on the <strong class="bold">Regenerate Key</strong> option.</p></li>
				<li>Now, plot each of the following graphs using Plotly:<p>Bar graph:</p><div class="IMG---Figure" id="_idContainer176"><img alt="Figure 8.15: Bar graph of bank data" src="image/C12913_08_15.jpg"/></div></li>
			</ol>
			<h6>Figure 8.15: Bar graph of bank data</h6>
			<p>Scatter plot:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer177">
					<img alt="Figure 8.16: Scatter plot of bank data" src="image/C12913_08_16.jpg"/>
				</div>
			</div>
			<h6>Figure 8.16: Scatter plot of bank data</h6>
			<p>Boxplot:</p>
			<div>
				<div class="IMG---Figure" id="_idContainer178">
					<img alt="Figure 8.17: Boxplot of bank data" src="image/C12913_08_17.jpg"/>
				</div>
			</div>
			<h6>Figure 8.17: Box<a id="_idTextAnchor226"/>plot of bank data</h6>
			<h4>Note</h4>
			<p class="callout">The solution for this activity can be found on page 248.</p>
			<h2 id="_idParaDest-202"><a id="_idTextAnchor227"/>Summary</h2>
			<p>In this c<a id="_idTextAnchor228"/>hapter,<a id="_idTextAnchor229"/> we learned how to import data from various sources into a Spark environment as a Spark DataFrame. In addition, we learned how to carry out various SQL operations on that DataFrame, and how to generate various statistical measures, such as correlation analysis, identifying the distribution of data, building a feature importance model, and so on. We also looked into how to generate effective graphs using Plotly offline, where you can generate various plots to develop an analysis report.</p>
			<p>This book has hopefully offered a stimulating journey through big data. We started with Python and  covered several libraries that are part of the Python data science stack: NumPy and Pandas, We also looked at home we can use Jupyter notebooks. We then saw how to create informative data visualizations, with some guiding principles on what is a good graph, and used Matplotlib and Seaborn to materialize the figures. Then we made a start with the Big Data tools - Hadoop and Spark, thereby understanding the principles and the basic operations. </p>
			<p>We have seen how we can use DataFrames in Spark to manipulate data, and have about utilize concepts such as correlation and dimensionality reduction to better understand our data. The book has also covered  reproducibility, so that the analysis created can be supported and better replicated when needed, and we finished our journey with a final report. We hope that the subjects covered, and the practical examples in this book will help you in all areas of your own data journey.</p>
		</div>
	</body></html>