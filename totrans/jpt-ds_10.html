<html><head></head><body><div><h1 class="header-title">Optimizing Jupyter Notebooks</h1>
                
            
            
                
<p class="calibre5">Before a Jupyter Notebook is developed you should confront optimizations that should occur before the public starts their access. Optimizations cover a gamut of options running from language-specific issues (use best practice R coding style) to deploying your notebook in a highly available environment.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Deploying notebooks</h1>
                
            
            
                
<p class="calibre5">A Jupyter Notebook is a website. You could host a website on the computer that you are using to display this document. There may be a machine available in your department that is in use as a web server.</p>
<p class="calibre5">If you were to deploy on a local machine you would have a single user website where additional users would be blocked from access or would collide with each other. The first step towards publishing your notebook involves using a hosting service that provides multiple user access.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Deploying to JupyterHub</h1>
                
            
            
                
<p class="calibre5">The predominant Jupyter hosting product currently is JupyterHub. To be clear, JupyterHub is installed into a machine under your control. It provides multi-user access to your notebooks. This means you could install JupyterHub on a machine in your environment and only internal users (multiple internal users) could access it.</p>
<p class="calibre5">When JupyterHub starts it begins a hub or controlling agent. The hub will start an instance of a listener or proxy for Jupyter requests. When the proxy gets requests for Jupyter it turns them over to the hub. If the hub decides this is a new user it will generate a new instance of the Jupyter server and attach all further interactions between that user and Jupyter to their own version of the server. This feature provides multi-user access.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Installing JupyterHub</h1>
                
            
            
                
<p class="calibre5">JupyterHub requires Python 3.3 or better and we will use the Python tool <kbd class="calibre21">pip3</kbd> to install JupyterHub. The commands to install are:</p>
<pre class="commandlinepackt"><strong class="calibre3">npm install -g configurable-http-proxy</strong>
<strong class="calibre3">pip3 install jupyterhub</strong>  </pre>


            

            
        
    </div>



  
<div><h1 class="header-title">Accessing a JupyterHub Installation</h1>
                
            
            
                
<p class="calibre5">We can now start JupyterHub directly from the command line:</p>
<pre class="commandlinepackt"><strong class="calibre3">jupyterhub</strong>  </pre>
<p class="calibre5">Instead of the typical <kbd class="calibre21">jupyter notebook</kbd> that you have been using.</p>
<p class="calibre5">Again, as discussed, JupyterHub is the entry point for users accessing your notebooks. Under the covers it is instantiating Jupyter instances for users.</p>
<p class="calibre5">There are slight differences with the user interface presented as well, as shown in the following screenshot:</p>
<div><img class="image-border158" src="img/0a6619ba-2d9b-4df8-8dc1-ca2391c2899b.png"/></div>
<p class="calibre5">Note the additional buttons on the top right of the screen:</p>
<ul class="calibre19">
<li class="calibre20">Control Panel: For control of JupyterHub</li>
<li class="calibre20">Logout: Logout would be used with the SSL feature of JupyterHub to control access to your notebook </li>
</ul>
<p class="calibre5">The Control Panel gives two options:</p>
<ul class="calibre19">
<li class="calibre20">Stop My Server: Stops JupyterHub from responding further. Useful if you need to upgrade some part of the system.</li>
<li class="calibre20">My Server: Return to the JupyterHub home page (previous screenshot).</li>
</ul>
<p class="calibre5">If you start two browser instances on your desktop and access the notebook on JupyterHub you would be presented different information for each user as the user information is separately allocated to each user.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Jupyter hosting</h1>
                
            
            
                
<p class="calibre5">If you want to share your notebook with a larger audience one of the better mechanisms is to use a public hosting service for presenting your notebook. This alleviates the need for some of the extensive security and availability requirements you would incur doing this yourself.</p>
<p class="calibre5">There are an increasing number of (hosting) vendors that are providing Jupyter Notebook hosting as well. A couple of the major vendors are:</p>
<ul class="calibre19">
<li class="calibre20"><strong class="calibre3">Rackspace</strong>: Rackspace is particularly geared towards education notebooks where they provide special handling for clients running from the education sector</li>
<li class="calibre20"><strong class="calibre3">Azure</strong>: The server hosting service by Microsoft—provides full notebook hosting</li>
<li class="calibre20"><strong class="calibre3">GitHub</strong>: One of the primary source repositories for programming artifacts, such as your notebook</li>
</ul>
<p class="calibre5">A great feature of these hosting services is you no longer must install any libraries you are accessing from your notebook script. The hosting companies have already downloaded (and maintained and updated) all the libraries that you would normally use. GitHub does this maintenance. The others are pure web-hosting companies and expect you to install any necessary software needed.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Optimizing your script</h1>
                
            
            
                
<p class="calibre5">There are optimizations that you can make to have your notebook scripts run more efficiently. The optimizations are script language dependent. We have covered using Python and R scripts in our notebooks and will cover optimizations that can be made for those two languages.</p>
<p class="calibre5">Jupyter does support additional languages, such as Scala and Spark. The other languages have their own optimization tools and strategies.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Optimizing your Python scripts</h1>
                
            
            
                
<p class="calibre5">Performance tuning your Python scripts can be done using several tools:</p>
<ul class="calibre19">
<li class="calibre20"><kbd class="calibre21">timeit</kbd></li>
<li class="calibre20">Python regular expressions</li>
<li class="calibre20">String handling</li>
<li class="calibre20">Loop optimizations</li>
<li class="calibre20"><kbd class="calibre21">hotshot</kbd> profiling</li>
</ul>


            

            
        
    </div>



  
<div><h1 class="header-title">Determining how long a script takes</h1>
                
            
            
                
<p class="calibre5">The <kbd class="calibre21">timeit</kbd> function in Python takes a line of code and determines how long it takes to execute. You can also repeatedly execute the same script to see if there are start-up issues that need to be addressed.</p>
<p class="calibre5"><kbd class="calibre21">timeit</kbd> is used in this manner:</p>
<pre class="commandlinepackt"><strong class="calibre3">import timeit</strong>
<strong class="calibre3">t = timeit.Timer("myfunction('Hello World')", "import myfunction")   </strong>
<strong class="calibre3">t.timeit()              </strong>
<strong class="calibre3">3.32132323232</strong>
<strong class="calibre3">t.repeat(2, 2000000)    </strong>
<strong class="calibre3">[#, #, #]</strong>  </pre>
<p class="calibre5">The <kbd class="calibre21">repeat()</kbd> function is telling <kbd class="calibre21">timeit</kbd> to execute the timed instruction two times at 2,000,000 times each. The numbers displayed after the <kbd class="calibre21">repeat()</kbd> call are the three of the times taken as representative of the repeated calls.</p>
<p class="calibre5">You would normally use this to test out a complete function, not something that interacts with the user in any way.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Using Python regular expressions</h1>
                
            
            
                
<p class="calibre5">There are many cases where you need your script to evaluate a string of data, possibly entered by a user. Yes, you could do this by hand, but the Python regular expression processing is extremely efficient and catches all the edge cases that you may not be aware of.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Using Python string handling</h1>
                
            
            
                
<p class="calibre5">Strings are notoriously bad allocations of memory repeatedly as slight changes are made to the string. Furthermore, even small things such as capitalizing a letter in a larger string means a reallocation. Best off to process an entire string, such as capitalizing, in one step as we reduce the reallocation to one shot.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Minimizing loop operations</h1>
                
            
            
                
<p class="calibre5">There are many times when you develop a script that you place steps inside of a loop as it was convenient to do so when developed and probably did not make much difference to performance when running against smaller test data. For example, on any of the scripts in this book I would normally extract a small set of rows to work with. That would provide confidence that I am accessing the data correctly. However, I may have adjusted loop operations to have flagging operations occur. On a smaller dataset of 20 rows or so there is no big effect. However, when I start using the true dataset, which may have millions of rows, the setting of that flag continuously for every row would affect the overall performance of the operation.</p>
<p class="calibre5">However, once you are working with larger data those minor operations that are occurring every time the loop executes become expensive. There are usually operations that can be pulled out of the loop and executed once outside of the loop. For example, if we were looking for the largest number in a loop we would initialize our result outside of the loop to an unrealistic value and inside the loop, if we see the unrealistic value we initialize the result with the first result. This test occurs on every loop operation. Instead we could set the result from the first record BEFORE entering the loop.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Profiling your script</h1>
                
            
            
                
<p class="calibre5">The hotshot profiler is available in Python to give a complete rundown of the execution of your script. Hotshot would have to be installed for you to execute.</p>
<p class="calibre5">It can be used as follows:</p>
<pre class="commandlinepackt"><strong class="calibre3">import hotshot</strong>
<strong class="calibre3">import myfunction</strong>
<strong class="calibre3">prof = hotshot.Profile('my_hotshot _stats')</strong>
<strong class="calibre3">prof.run('myfunction').close()</strong></pre>
<p class="calibre5">Then to view a summary of the profiler's results use the commands:</p>
<pre class="commandlinepackt"><strong class="calibre3">import hotshot.stats</strong>
<strong class="calibre3">hotshot.stats.load('my_hotshot_stats').strip_dirs().sort_stats('time').print_stats()</strong>  </pre>


            

            
        
    </div>



  
<div><h1 class="header-title">Optimizing your R scripts</h1>
                
            
            
                
<p class="calibre5">R also has tools available that will help pinpoint performance issues with your R coding:</p>
<ul class="calibre19">
<li class="calibre20"><kbd class="calibre21">microbenchmark</kbd></li>
<li class="calibre20">Modify a function used frequently</li>
<li class="calibre20">Optimize name lookup</li>
<li class="calibre20">Optimize data frame value extraction</li>
<li class="calibre20">R implementations</li>
<li class="calibre20">Change algorithm</li>
</ul>


            

            
        
    </div>



  
<div><h1 class="header-title">Using microbenchmark to profile R script</h1>
                
            
            
                
<p class="calibre5"><kbd class="calibre21">microbenchmark</kbd> is provided as part of an R library. Once included in your script you then surround the code in question with a <kbd class="calibre21">microbenchmark</kbd> tag and once executed the tool will output profiling information for the script in question.</p>
<p class="calibre5">For example, we could have this use:</p>
<pre class="commandlinepackt"><strong class="calibre3">library(microbenchmark)</strong>
<strong class="calibre3">x &lt;- runif(125) </strong>
<strong class="calibre3">microbenchmark( mean(x) )</strong>  </pre>
<p class="calibre5">Which would exercise the surrounded code 125 times (100 by default) and output profiling information such as:</p>
<pre class="commandlinepackt"><strong class="calibre3">Unit: nanoseconds</strong>
<strong class="calibre3">    expr  min     lq    mean median     uq   max neval</strong>
<strong class="calibre3"> sqrt(x)  825  860.5 1212.79  892.5  938.5 12905   100</strong>
<strong class="calibre3">   x^0.5 3015 3059.5 3776.81 3101.5 3208.0 15215   100 </strong>  </pre>
<p class="calibre5">Where we are concerned with the mean as a good indication of how long each iteration is taking. We should also notice where there is a large divergence from the mean with very distant min and max values—which is what we have here.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Modifying provided functionality</h1>
                
            
            
                
<p class="calibre5">R allows you to change the behavior of most objects, including most well-known functions provided. An extreme example would be to rework how the <kbd class="calibre21">mean()</kbd> function works. Maybe you have insight into the exact nature of the data you are working with and can increase performance accordingly in your special case.</p>
<p class="calibre5">As with the preceding tool, you could exercise the provided functionality and then your implementation, and compare profile information provided by <kbd class="calibre21">microbenchmark</kbd>.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Optimizing name lookup</h1>
                
            
            
                
<p class="calibre5">R allows for dynamic naming of objects, so every time you access a variable R must look through a list of scopes to find where the object currently resides.</p>
<p class="calibre5">You may instead use a local cache mechanism to access your exact value directly circumventing R looking for a variable in all scopes.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Optimizing data frame value extraction</h1>
                
            
            
                
<p class="calibre5">With its variety of coding styles R allows you to access a particular value in a data frame in several manners. If your coding is accessing a large data frame frequently to extract singular values it is worthwhile to benchmark different alternatives to see which access method provides the most performance.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Changing R Implementation</h1>
                
            
            
                
<p class="calibre5">R is implemented by a handful of different companies. Each has its own performance spectrum. It may be worthwhile with severe cases to experiment with different R implementations to determine which works best for you. It may be difficult to change the R engine used by Jupyter.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Changing algorithms</h1>
                
            
            
                
<p class="calibre5">Whenever you program your notebook you have taken an approach to solving the problem. The approach is referred to as the <em class="calibre18">algorithm</em> used. Your algorithm may include looping over records or querying records inside of the database directly to obtain the records of interest. Many times, you will select an algorithm early in the process which appears to work adequately. There may be other algorithms which solve the problem in a much more efficient manner.</p>
<p class="calibre5">The largest boost to any programming implementation will come by changing the overall approach to handling. Unfortunately, this is the hardest change to accomplish as redesign and rewrite of your coding is required. And even then, like the other techniques, you need to compare benchmarks of your different approaches to make sure the new approach is better.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Monitoring Jupyter</h1>
                
            
            
                
<p class="calibre5">As with the earlier discussions in this chapter on optimization, you can also use programming tools to monitor the overall interactions of your notebook. The predominant tool for Linux/Mac environments is <kbd class="calibre21">memory_profiler</kbd>. If you start this tool then your notebook, the profiler will keep track of memory use of your notebook.</p>
<p class="calibre5">With this record of information points you may be able to adjust your programmatic memory allocation to be smaller in profile if you find a large memory use occurring. For example, the profiler may highlight that you are creating (and dropping) a large memory item continuously inside of a loop. When you go back to your coding you realize this memory access could be pulled out of the loop and just done once or that size of the allocation could be minimized easily.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Caching your notebook</h1>
                
            
            
                
<p class="calibre5">Caching is a common programming practice to speed up performance. If the computer does not have to reload a section of code or variable or file, but can just access directly from a cache this will improve performance.</p>
<p class="calibre5">There is a mechanism to cache your notebook if you are deploying into a Docker space. Docker is a mechanism for virtualizing code over many instances in one machine. It has become common practice to do so in the Java programming world. Luckily, Docker is very flexible and a method has been determined to use Jupyter in Docker as well. Once in Docker, it is a minor adjustment to automatically cache your pages in Docker. The underlying tool used is <kbd class="calibre21">memcached</kbd>, yet another widespread common tool for caching anything, in this case Jupyter Notebooks.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Securing a notebook</h1>
                
            
            
                
<p class="calibre5">Securing a notebook can be accomplished by several methods such as:</p>
<ul class="calibre19">
<li class="calibre20">Manage authorization</li>
<li class="calibre20">Securing notebook content</li>
</ul>


            

            
        
    </div>



  
<div><h1 class="header-title">Managing notebook authorization</h1>
                
            
            
                
<p class="calibre5">A notebook can be secured to use username/password authorization. Authorization is on by default in your notebook. Under Jupyter it is token/password instead of username/password as a token is more open to interpretation. See Jupyter documentation on implementing authorization as this has changed slightly over time.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Securing notebook content</h1>
                
            
            
                
<p class="calibre5">A notebook has possible security issues with several parts of standard content that are secured automatically by Jupyter:</p>
<ul class="calibre19">
<li class="calibre20">Untrusted HTML is sanitized</li>
<li class="calibre20">Untrusted JavaScript is not executed</li>
<li class="calibre20">HTML and JavaScript in markdown cells is not trusted</li>
<li class="calibre20">Notebook output is not trusted</li>
<li class="calibre20">Other HTML or JavaScript in the notebook is not trusted</li>
</ul>
<p class="calibre5">Where trust comes down to the question: Did the user do this or did the Jupyter script? Untrusted means it will not be generated.</p>
<p class="calibre5">Sanitized code is wrapped to force the values to be text display only—no executed code will be generated. For example, if your notebook cell were to produce HTML, such as an additional <kbd class="calibre21">H1</kbd> header tag, Jupyter would sanitize the output such that the raw HTML, in this case something like <kbd class="calibre21">&lt;H1&amp;gt;Additional Heading&lt;/H1&amp;gt;</kbd> would produce the raw HTML with the <kbd class="calibre21">H1</kbd> tags rather than the desired effect of an HTML heading appearing on your page.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Scaling Jupyter Notebooks</h1>
                
            
            
                
<p class="calibre5">Scaling is the process of providing very large numbers of concurrent users to a notebook without a degradation in performance. The one vendor that is doing this today is Azure. They have thousands of pages and users working at scale daily.</p>
<p class="calibre5">Most amazingly this is a <strong class="calibre7">free</strong> service.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Sharing Jupyter Notebooks</h1>
                
            
            
                
<p class="calibre5">Jupyter Notebooks can be shared by placing the notebook on a server (there are several kinds) or converting the notebook to another format (it will not be interactive, but the content will be available).</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Sharing Jupyter Notebook on a notebook server</h1>
                
            
            
                
<p class="calibre5">Built into the notebook configuration are extensions that can be used to expose a notebook server, directly. The notebook configuration can be generated using the following command:</p>
<pre class="commandlinepackt"><strong class="calibre3">Jupyter Notebook -generate-config</strong>  </pre>
<p class="calibre5">In the resulting <kbd class="calibre21">jupyter_notebook_config.py</kbd> file there are settings that can be used to set:</p>
<ul class="calibre19">
<li class="calibre20">IP/port address of your notebook</li>
<li class="calibre20">Encryption certificate location</li>
<li class="calibre20">Password</li>
</ul>
<p class="calibre5">By setting this and starting Jupyter you should be able to access the notebook at the IP address specified from other machines in your network.</p>
<p>You should work with your network security personnel before doing so.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Sharing encrypted Jupyter Notebook on a notebook server</h1>
                
            
            
                
<p class="calibre5">If you specify the certificate information correctly in the previous configuration file the notebook will only be accessible over HTTPS or a secure, encrypted channel.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Sharing notebook on a web server</h1>
                
            
            
                
<p class="calibre5">Another part of the configuration file is the <kbd class="calibre21">tornado_settings</kbd>. This set of settings describes the web server that will channel web traffic to your notebook. Again, once these settings are in place you can access your notebook through the web server-using the web servers IP address.</p>
<p class="calibre5">This might be useful to present notebook access as part of your existing website.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Sharing notebook on Docker</h1>
                
            
            
                
<p class="calibre5">Docker is a framework that provides for hosting instances of software based on a small configuration file, the <kbd class="calibre21">Dockerfile</kbd>. Docker allows for multiple instances of software to be instantiated automatically as needed. So, we would have multiple instances of our notebook available to users. Users would not be able to distinguish the multiple instances as they just reference the one notebook. Docker redirects user traffic to one or the other instances based on initial connection to the system.</p>
<p class="calibre5">The <kbd class="calibre21">Dockerfile</kbd> has the environment settings that tell the Docker system what system components need to be present in an instance in order for the referenced object, in this case a notebook, can be executed.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Converting a notebook</h1>
                
            
            
                
<p class="calibre5">You can also share a notebook with others by converting the notebook to a readable form for recipients. Notebooks can be converted to a number of formats using the Download As feature in the notebook File menu.</p>
<p class="calibre5">Notebooks can be converted in this way to the formats:</p>
<ul class="calibre19">
<li class="calibre20"><strong class="calibre3">&lt;language&amp;gt; format</strong>: This option is dependent on the language used to create the notebook. For example, an R notebook would have the choice to Download as R script.</li>
<li class="calibre20">HTML: This representation is the HTML encoding to display the page as it appears in your notebook using HTML constructs.</li>
<li class="calibre20">Markdown: Markdown is a simple display tag format used by some older Linux systems.</li>
<li class="calibre20">reST: Another markdown type of format that has simpler display constructs than HTML.</li>
<li class="calibre20">PDF.</li>
</ul>


            

            
        
    </div>



  
<div><h1 class="header-title">Versioning a notebook</h1>
                
            
            
                
<p class="calibre5">A common practice in the programming world is to maintain a history of the changes made to a program. Over time the different versions of the program are maintained in a software repository where the programmer can retrieve prior versions to return to an older, working state of their program.</p>
<p class="calibre5">In the previous section we mentioned placing your notebook on GitHub. Git is a software repository in wide use. GitHub is an internet-based instance of Git. Once you have any software in Git it will automatically be versioned. The next time you update your notebook in GitHub. Git will take the current instance, store it as a version in your history, and place the new instance as the current—where anyone accessing your GitHub repository will see the latest version by default.</p>


            

            
        
    </div>



  
<div><h1 class="header-title">Summary</h1>
                
            
            
                
<p class="calibre5">In this chapter, we deployed our notebook to a set of different environments. We looked into optimizations that can be made to our notebook scripts. We learned about different ways to share our notebook. Lastly, we looked into converting our notebook for users without access to Jupyter.</p>


            

            
        
    </div>



  </body></html>